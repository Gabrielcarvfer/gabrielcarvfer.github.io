<!DOCTYPE html> <html lang=""> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Warp-speeding the captain of the Starfleet | Gabriel C. Ferreira</title> <meta name="author" content="Gabriel C. Ferreira"> <meta name="description" content="A bunch of random stuff "> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%A4%8C&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="/metabrainz/2020/12/17/picard-the-captain-of-the-starfleet.html"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Gabriel </span>C. Ferreira</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Warp-speeding the captain of the Starfleet</h1> <p class="post-meta">December 17, 2020</p> <p class="post-tags"> <a href="/blog/2020"> <i class="fas fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/category/metabrainz"> <i class="fas fa-tag fa-sm"></i> MetaBrainz</a>   </p> </header> <article class="post-content"> <p>Have you ever heard of <a href="https://picard.musicbrainz.org/" rel="external nofollow noopener" target="_blank">MusicBrainz Picard</a>? It is an amazing piece of software that makes tagging music files a breeze. Not only that, but it can also be used to fingerprint your music files, identify the recording and pull up metadata from the MusicBrainz servers.</p> <p>I got some spare time earlier this year and decided to tag my long-abandoned music library. Started by downloading the latest version of Picard, then installed it. After that I executed the binary and finally clicked to scan my library folder.</p> <p>And then I waited… And waited… And waited… Jesus, what is this thing doing? It was barely touching the disk drive, but the single thread was pinned at 100% load. It clearly had a bottleneck somewhere and I had to find it. Started looking into the code that performed the load and the profilers quickly indicated troublesome spots, which I thought could be spread into multiple processes to speed things up. Spent some time trying to make it work and failed miserably due to circular dependencies between the logic components and the GUI.</p> <p>Then I tried looking in the forums because I must be doing something wrong. I have found a few people complaining about performance. After that, I dug their issue tracker and hit gold. <a href="https://tickets.metabrainz.org/browse/PICARD-975" rel="external nofollow noopener" target="_blank">Issue 975 - Reimplement the threading code in Picard</a>.</p> <p>One of Picard’s contributors, Sophist gave me a few hints <a href="https://tickets.metabrainz.org/browse/PICARD-975?focusedCommentId=53339&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-53339" rel="external nofollow noopener" target="_blank">where to look at</a>. After assuming the bottleneck was CPU-bound, I’ve proposed a <a href="https://tickets.metabrainz.org/browse/PICARD-975?focusedCommentId=53340&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-53340" rel="external nofollow noopener" target="_blank">multi-process architecture</a>. It ended up being a dumb way to deal with the issue, but we will come to that later.</p> <p><img src="/assets/img/2020-12-17-picard-the-captain-of-the-starfleet/picard_multiprocess.png" alt="drawing" width="100%"></p> <p>We then discussed a bit and I started looking into the areas suggested by Sophist. I decided that batch processing would probably speed things up, as instructions/data would be cached. I was partially correct, and managed to reduce load times from <a href="https://tickets.metabrainz.org/browse/PICARD-975?focusedCommentId=53349&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-53349" rel="external nofollow noopener" target="_blank">20 minutes down to 8 minutes</a>. It was huge. Got pretty excited with the results and decided to properly profile things.</p> <p>And then we hit the first major breakthrough:</p> <h4 id="1---when-the-slow-path-is-too-slow-having-a-fast-path-is-a-good-idea">1 - When the slow path is too slow, having a fast path is a good idea</h4> <p>The cProfiler indicated that most of the remaining time during load was due to trying to guess the file format based on file headers instead of using the file extension. It so happens that most of the time the files extensions are correct, and we could skip trying to identify the file. If the load failed, we could fallback to trying to guess the file format. That alone reduced load times even further, from 20 minutes down to 3.5 minutes. It became my first <a href="https://github.com/metabrainz/picard/pull/1529" rel="external nofollow noopener" target="_blank">pull request</a> for Picard. Pretty exciting.</p> <hr> <p>After that, I tried a bunch more stuff to make things faster, but nothing seemed to change. Then I started looking at the IO performance. Mainstream Picard barely reached 3MBps while reading the files. The batch version was much faster, reaching up to <a href="https://tickets.metabrainz.org/browse/PICARD-975?focusedCommentId=53354&amp;page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-53354" rel="external nofollow noopener" target="_blank">39MBps</a>, but it also prevented the UI from updating, causing freezes.</p> <p>There was definitely something messed up, and thread starvation seemed to make sense. It so happens that the directory scanning thread, that fed file loading threads, was executed concurrently instead of running at once and then dispatching the work. That made Picard randomly access the disk while trying to load songs at the same time it scanned directories. A.k.a. the worst-case scenario for HDDs.</p> <p>By scanning first and processing later, we drastically reduced thread wait times.</p> <p><img src="/assets/img/2020-12-17-picard-the-captain-of-the-starfleet/picard_threading_profiling.png" alt="drawing" width="100%"></p> <p>And then we hit the second major breakthrough:</p> <h4 id="2---poor-loading-threads-were-starving-to-death-while-scanning-thread-was-trying-to-keep-up">2 - Poor loading threads were starving to death while scanning thread was trying to keep up</h4> <p>Improving the scanning thread and letting it completely scan the directories before dispatching work for other threads was essential to boost performance. This change alone reduced loading times of a different library from 32 minutes down to 13 minutes, as reported in my second <a href="https://github.com/metabrainz/picard/pull/1531" rel="external nofollow noopener" target="_blank">pull request</a>.</p> <hr> <p>We ended up moving discussion from their issue tracker to that previous pull request thread. The IO issues seemed to be solved, but now it was the UI that could not keep up with the file loading, causing freezes and stutters. This is where things turned out way more difficult to profile than I initially expected.</p> <p>Tried some really complicated stuff, like <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-625004549" rel="external nofollow noopener" target="_blank">caching metadata to skip reloading files</a> and part of the <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-626184738" rel="external nofollow noopener" target="_blank">multi-process architecture</a>.</p> <p>Profilers pointed at different things all the time: first <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-623181143" rel="external nofollow noopener" target="_blank">updating the file items</a>, then <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-626377501" rel="external nofollow noopener" target="_blank">the file loading finalization</a>, then <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-629534654" rel="external nofollow noopener" target="_blank">the sorting algorithm</a>, and finally <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-629534654" rel="external nofollow noopener" target="_blank">the sorting of the panels</a>.</p> <p>Surprisingly, temporarily disabling the sorting of the panels was super effective, and our third breakthrough.</p> <h4 id="3---sorting-over-and-over-an-ever-increasing-list-is-insane-and-ui-draws-are-super-expensive">3 - Sorting over and over an ever-increasing list is insane and UI draws are super expensive</h4> <p>We disabled the sorting during operations that involve moving/adding/removing large amounts of files (e.g. loading/clustering). This reduced drawing times of the items in the panel from <a href="https://github.com/metabrainz/picard/pull/1531#issuecomment-629534654" rel="external nofollow noopener" target="_blank">30 minutes down to 1 minute</a>.</p> <hr> <p>It was at this point I realized the previous changes were way too much and we could achieve basically the same great results with fewer changes. Remember when I said the multi-process solution was dumb? This is the point I realized it was the case.</p> <p>Putting the previous 2 breakthroughs into a <a href="https://github.com/metabrainz/picard/pull/1543" rel="external nofollow noopener" target="_blank">single PR</a>, we manage to reduce loading times of a third library from <strong>50m down to 6m</strong>. At the same time, clustering times fell from <strong>5h17min down to 3 minutes</strong>.</p> <p>But I was not done just yet. I could feel the profilers were messing with me. How could I have changed a ton of stuff, and instead of processing times falling they would just move around to different functions? Quite puzzling.</p> <p>The answer was the profilers just could not measure the problem because it was not in python, but outside python. What do I mean by that? The C libraries that took the GIL and blocked python were the culprits. I decided to move some of the modules to cython to track exactly where the calls were made and voilà. Two missing Qt size hints were <a href="https://github.com/metabrainz/picard/pull/1555#issuecomment-644475419" rel="external nofollow noopener" target="_blank">two large contributors to the UI slowdown</a>.</p> <p>Our fourth breakthrough:</p> <h4 id="4---qt-documentation-is-poor-and-profiling-mixed-language-software-is-nightmarish">4 - Qt documentation is poor, and profiling mixed language software is nightmarish</h4> <p>Yes, two Qt size hints were enough to improve the UI responsiveness by a huge margin. Those were two one-liners but reduced the CPU samples from 40% down to 10% of total samples. This means Picard can actually do useful stuff instead of guessing sizes during repaints of the UI.</p> <p><em>Without hints</em> = 40% of CPU samples <img src="/assets/img/2020-12-17-picard-the-captain-of-the-starfleet/picard_without_hint.png" alt="drawing" width="100%"></p> <p><em>With hints</em> = 10% of CPU samples <img src="/assets/img/2020-12-17-picard-the-captain-of-the-starfleet/picard_with_hint.png" alt="drawing" width="100%"></p> <p>Side effects? <a href="https://github.com/metabrainz/picard/pull/1555#issuecomment-644860437" rel="external nofollow noopener" target="_blank">150x speedup</a> on moving files during clustering with expanded clusters (worst case scenario) + sorting disabled. People used to recommend collapsing the clusters to speed things up, but it got solved by two one-line hints. Completely crazy.</p> <hr> <p>With this, I was pretty much done, but the UI still had some freezing/hiccup issues, especially in Windows. After further profiling, I have noticed the worker threads had a lot of contention while checking configuration variables. They spent a ton of time waiting for each other due to locks. To prevent them from locking, we only locked the reader threads if the cached setting was marked as stale/dirty or when a thread needed the lock to update the setting. This was done in this <a href="https://github.com/metabrainz/picard/commit/18c4e93cf1073e21857e4e39d311eb28d9d8f76f" rel="external nofollow noopener" target="_blank">commit</a>.</p> <p>Other area of Picard that drastically slowed things down was selecting tracks. They updated the metadata box, which can be awfully expensive depending on how many items are selected. I tried to mitigate the issue <a href="https://github.com/metabrainz/picard/commit/6ef6679f65e68796cfdf8be2d63307f5b1400305" rel="external nofollow noopener" target="_blank">here</a>, by preventing metadata box updates if the selection didn’t change. It seemed very logical to me (as I am trying to prevent reprocessing everything), but it ended up causing issues to other users. Tried a few more changes later, but it still ended up being changed as users reported other issues… My bad.</p> <h3 id="end-results">End results</h3> <p>As reported in ticket <a href="https://tickets.metabrainz.org/browse/PICARD-1844" rel="external nofollow noopener" target="_blank">PICARD-1844 - Further improve loading and clustering performance</a>, loading times fell from 50m down to 5m30s (~9x speedup), and clustering times fell from 5h to 2m (~150x speedup) in my library with 19k files. UI responsiveness is way harder to measure, so no hard measures on that, but you can try it by yourself. Touching mere 700 lines of code instead of rearchitecting the entire thing as I initially thought would be necessary… Changes were released in Picard 2.4.</p> <p>It was pretty fun and the results were great. Laurent (Zas), Philipp (outsidecontext) and Sophist (I don’t know his real name) were awesome and helped a lot.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Gabriel C. Ferreira. Powered by <a href="http://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: March 08, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>